---
- name: Operating System
  debug:
    msg: "{{ ansible_distribution }} {{ ansible_distribution_major_version }}"

- name: Tailscale Auth Key Required
  fail:
    msg: |
      You must include a Node Authorization auth key.
      Set a `tailscale_auth_key` ansible-vault encrypted variable.
      You can create this key from: https://login.tailscale.com/admin/authkeys
  when: tailscale_auth_key is not defined

- name: CentOS and related families
  when: ansible_distribution == 'CentOS' or ansible_distribution == 'Amazon'
  block:
    - name: Yum Dependencies
      become: yes
      yum:
        name: "{{ yum_dependencies }}"
        state: present

    - name: Add Yum Repo
      become: yes
      command: yum-config-manager --add-repo {{ yum_repos[ansible_distribution] }}
      args:
        creates: /etc/yum.repos.d/tailscale.repo

    - name: Install Tailscale
      become: yes
      yum:
        name: "{{ tailscale_package }}"
        disable_gpg_check: yes
        state: present

    - name: Enable Service
      become: yes
      service:
        name: "{{ tailscale_service }}"
        state: started
        enabled: yes

- name: Debian and related families
  when: ansible_distribution == 'Ubuntu' or ansible_distribution == 'Debian'
  block:
    - name: Apt Update
      become: yes
      apt:
        update_cache: yes

    - name: Apt Dependencies
      become: yes
      apt:
        name: "{{ apt_dependencies }}"
        state: present

    # FIXME: Replace with curl and creates: commands
    - name: Tailscale Signing Key
      become: yes
      apt_key:
        url: "{{ apt_signkey }}"
        state: present

    - name: Install Tailscale
      become: yes
      apt:
        name: "{{ tailscale_package }}"
        state: present
        update_cache: yes

- name: Bring Tailscale Up
  become: yes
  command: tailscale up --authkey={{ tailscale_auth_key }}
  # Since the auth key is included in this task, we do not want to log output
  no_log: true
  register: tailscale_start
  changed_when: tailscale_start.stderr != "\ntailscaled is authenticated, nothing more to do."
