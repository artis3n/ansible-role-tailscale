---
- name: Fetch Tailscale status
  listen: Confirm Tailscale is Connected
  ansible.builtin.command: tailscale status --json
  changed_when: false
  register: tailscale_status
  when: not ansible_check_mode

- name: Parse status JSON
  listen: Confirm Tailscale is Connected
  vars:
    status: "{{ tailscale_status.stdout | from_json }}"
  ansible.builtin.set_fact:
    tailscale_is_online: "{{ status.Self.Online }}"
  when: not ansible_check_mode

- name: return faked response from JSON status check when in check mode
  listen: Confirm Tailscale is Connected
  ansible.builtin.set_fact:
    tailscale_is_online: true
  when: ansible_check_mode

- name: Tailscale online status
  listen: Confirm Tailscale is Connected
  ansible.builtin.debug:
    msg: "Online: {{ tailscale_is_online }}"
  when: verbose

- name: Assert Tailscale is Connected
  listen: Confirm Tailscale is Connected
  ansible.builtin.assert:
    that:
      - tailscale_is_online
